<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ISS API proxy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body style="font-family:system-ui,Segoe UI,Roboto,-apple-system,Arial,sans-serif;padding:20px;">
  <pre id="out">Loadingâ€¦</pre>

<script>
(async function(){
  const out = document.getElementById('out');
  const params = new URLSearchParams(location.search);
  const d = (params.get('d') || 'la').toLowerCase(); // ts, la, lo

  if (!['ts','la','lo'].includes(d)) {
    out.textContent = 'Invalid param. Use ?d=ts | ?d=la | ?d=lo';
    return;
  }

  // Step 1: Request access key each reload
  const accessUrl = 'https://cors-anywhere.herokuapp.com/corsdemo?accessRequest=07153f7d4ddee3c9f4aba6d6f12783ce7c88292e9b79148b0c4b929271c0ce22';
  try {
    await fetch(accessUrl, { mode: 'cors' });
  } catch (e) {
    out.textContent = 'Failed to get CORS access: ' + e;
    return;
  }

  // Step 2: Fetch ISS data using CORS Anywhere proxy
  const corsProxy = 'https://cors-anywhere.herokuapp.com/';
  const targetUrl = 'http://api.open-notify.org/iss-now.json';
  const fullUrl = corsProxy + targetUrl;

  try {
    const res = await fetch(fullUrl);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    let result = '';
    if (d === 'ts') result = String(data.timestamp ?? '');
    if (d === 'la') result = String(data.iss_position?.latitude ?? '');
    if (d === 'lo') result = String(data.iss_position?.longitude ?? '');

    document.body.innerHTML = '';
    const pre = document.createElement('pre');
    pre.style.fontSize = '16px';
    pre.style.whiteSpace = 'pre-wrap';
    pre.textContent = result;
    document.body.appendChild(pre);
    document.title = result;
  } catch (err) {
    out.textContent = 'Error fetching ISS data: ' + err;
  }
})();
</script>
</body>
</html>
