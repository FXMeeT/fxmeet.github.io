<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AES File Encrypt/Decrypt</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    button, a { margin-top: 10px; padding: 8px 14px; cursor: pointer; display:inline-block; }
    input[type="file"], input[type="text"] { margin-top: 10px; padding: 6px; width: 320px; }
    .section { margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; max-width: 450px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>AES File Tool</h2>

  <label><input type="radio" name="mode" value="encode" onclick="switchMode('encode')"> Encode</label>
  <label><input type="radio" name="mode" value="decode" onclick="switchMode('decode')"> Decode</label>

  <!-- Encode -->
  <div id="encodeSection" class="section hidden">
    <h3>Encode</h3>
    <input type="file" id="encodeFile"><br>
    <div style="display:flex; gap:6px; align-items:center;">
      <input type="text" id="encodeKey" readonly placeholder="Generated key will appear here">
      <button onclick="copyKey()">Copy</button>
    </div>
    <button onclick="encryptFile()">Encrypt</button><br>
    <a id="downloadEnc" class="hidden">Download Encrypted File</a>
  </div>

  <!-- Decode -->
  <div id="decodeSection" class="section hidden">
    <h3>Decode</h3>
    <input type="file" id="decodeFile"><br>
    <input type="text" id="decodeKey" placeholder="Paste key"><br>
    <button onclick="decryptFile()">Decrypt</button><br>
    <a id="downloadDec" class="hidden">Download Original File</a>
  </div>

<script>
function switchMode(mode) {
  document.getElementById("encodeSection").classList.add("hidden");
  document.getElementById("decodeSection").classList.add("hidden");
  if (mode === "encode") document.getElementById("encodeSection").classList.remove("hidden");
  else document.getElementById("decodeSection").classList.remove("hidden");
}

// --- Padding helpers (PKCS7) ---
function padData(data) {
  const blockSize = 16;
  const pad = blockSize - (data.length % blockSize);
  const padded = new Uint8Array(data.length + pad);
  padded.set(data);
  padded.fill(pad, data.length);
  return padded;
}
function unpadData(data) {
  const pad = data[data.length-1];
  return data.slice(0, data.length - pad);
}

// --- MIME Lookup ---
function getMimeByExt(ext) {
  const map = {
    "mp3": "audio/mpeg",
    "mp4": "video/mp4",
    "wav": "audio/wav",
    "ogg": "audio/ogg",
    "pdf": "application/pdf",
    "zip": "application/zip",
    "doc": "application/msword",
    "docx": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "xls": "application/vnd.ms-excel",
    "xlsx": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "ppt": "application/vnd.ms-powerpoint",
    "pptx": "application/vnd.openxmlformats-officedocument.presentationml.presentation",
    "txt": "text/plain",
    "jpg": "image/jpeg",
    "jpeg": "image/jpeg",
    "png": "image/png",
    "gif": "image/gif",
    "json": "application/json",
    "csv": "text/csv"
  };
  return map[ext.toLowerCase()] || "application/octet-stream";
}

// --- ENCRYPT ---
async function encryptFile() {
  const file = document.getElementById("encodeFile").files[0];
  if (!file) return alert("No file selected!");

  // generate AES-256 key
  const key = await crypto.subtle.generateKey({name:"AES-CBC", length:256}, true, ["encrypt","decrypt"]);
  const raw = await crypto.subtle.exportKey("raw", key);
  const b64Key = btoa(String.fromCharCode(...new Uint8Array(raw)));
  document.getElementById("encodeKey").value = b64Key;

  const iv = crypto.getRandomValues(new Uint8Array(16));
  const data = new Uint8Array(await file.arrayBuffer());
  const padded = padData(data);

  const encrypted = await crypto.subtle.encrypt({name:"AES-CBC", iv}, key, padded);

  // save: iv + encrypted
  const blob = new Blob([iv, new Uint8Array(encrypted)], { type: "application/octet-stream" });
  const link = document.getElementById("downloadEnc");
  link.href = URL.createObjectURL(blob);
  link.download = file.name + ".enc"; // keep original filename + .enc
  link.classList.remove("hidden");
  link.textContent = "Download " + link.download;
}

// --- DECRYPT ---
async function decryptFile() {
  const file = document.getElementById("decodeFile").files[0];
  if (!file) return alert("No encrypted file selected!");
  const b64Key = document.getElementById("decodeKey").value.trim();
  if (!b64Key) return alert("No key provided!");

  const rawKey = Uint8Array.from(atob(b64Key), c => c.charCodeAt(0));
  const key = await crypto.subtle.importKey("raw", rawKey, {name:"AES-CBC"}, false, ["decrypt"]);

  const bytes = new Uint8Array(await file.arrayBuffer());
  const iv = bytes.slice(0,16);
  const data = bytes.slice(16);

  try {
    const decrypted = await crypto.subtle.decrypt({name:"AES-CBC", iv}, key, data);
    const unpadded = unpadData(new Uint8Array(decrypted));

    // build new filename: originalname.dec.ext
    let name = file.name.replace(/\.enc$/, ""); // strip .enc
    let base = name, ext = "";
    const lastDot = name.lastIndexOf(".");
    if (lastDot !== -1) {
      base = name.substring(0, lastDot);
      ext = name.substring(lastDot + 1);
    }

    const mime = ext ? getMimeByExt(ext) : "application/octet-stream";
    const blob = new Blob([unpadded], { type: mime });

    const link = document.getElementById("downloadDec");
    link.href = URL.createObjectURL(blob);
    link.download = ext ? base + ".dec." + ext : base + ".dec";
    link.classList.remove("hidden");
    link.textContent = "Download " + link.download;

  } catch(e) {
    console.error(e);
    alert("❌ Decryption failed. Wrong key or corrupted file.");
  }
}

// --- Copy Key ---
function copyKey() {
  const keyField = document.getElementById("encodeKey");
  if (!keyField.value) return alert("No key to copy!");
  navigator.clipboard.writeText(keyField.value).then(() => {
    alert("Key copied to clipboard ✅");
  }).catch(err => {
    console.error(err);
    alert("Copy failed");
  });
}
</script>
</body>
</html>
